"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.adapterFactory = exports.MochaAdapter = exports.default = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _mocha = _interopRequireDefault(require("mocha"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _utils = require("@wdio/utils");

var _utils2 = require("./utils");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const log = (0, _logger.default)('@wdio/mocha-framework');
const MOCHA_UI_TYPE_EXTRACTOR = /^(?:.*-)?([^-.]+)(?:.js)?$/;
const DEFAULT_INTERFACE_TYPE = 'bdd';

class MochaAdapter {
  constructor(cid, config, specs, capabilities, reporter) {
    this.cid = cid;
    this.capabilities = capabilities;
    this.reporter = reporter;
    this.specs = specs;
    this.config = Object.assign({
      mochaOpts: {}
    }, config);
    this.runner = {};
    this.level = 0;
    this.suiteCnt = new Map();
    this.hookCnt = new Map();
    this.testCnt = new Map();
    this.suiteIds = ['0'];
    this.retrySuite = this.config.mochaOpts.retrySuite || 0;
    this.retried = {};
    this.nextRetry = null;
    this.runtimeError = null;
    this._hasTests = true;
  }

  async init() {
    const {
      mochaOpts
    } = this.config;
    const mocha = this.mocha = new _mocha.default(mochaOpts);
    mocha.loadFiles();
    mocha.reporter(_constants.NOOP);
    mocha.fullTrace();
    this.specs.forEach(spec => mocha.addFile(spec));
    mocha.suite.on('pre-require', this.preRequire.bind(this));

    this._loadFiles(mochaOpts);

    return this;
  }

  _loadFiles(mochaOpts) {
    if (this.config.featureFlags.specFiltering !== true) {
      return false;
    }

    try {
      this.mocha.loadFiles();
      const mochaRunner = new _mocha.default.Runner(this.mocha.suite);

      if (mochaOpts.grep) {
        mochaRunner.grep(this.mocha.options.grep, mochaOpts.invert);
      }

      this._hasTests = mochaRunner.total > 0;
    } catch (err) {
      log.warn('Unable to load spec files quite likely because they rely on `browser` object that is not fully initialised.\n' + '`browser` object has only `capabilities` and some flags like `isMobile`.\n' + 'Helper files that use other `browser` commands have to be moved to `before` hook.\n' + `Spec file(s): ${this.specs.join(',')}\n`, 'Error: ', err);
    }
  }

  hasTests() {
    return this.config.featureFlags.specFiltering !== true || this._hasTests;
  }

  async run() {
    const mocha = this.mocha;
    let runtimeError;

    const mochaRun = async mocha => {
      const result = await new Promise(resolve => {
        try {
          this.runner = mocha.run(resolve);
        } catch (e) {
          runtimeError = e;
          return resolve(1);
        }

        Object.keys(_constants.EVENTS).forEach(e => this.runner.on(e, this.emit.bind(this, _constants.EVENTS[e])));
        this.skipSuiteIfNeeded();
        this.runner.suite.beforeAll(this.wrapHook('beforeSuite'));
        this.runner.suite.afterAll(this.wrapHook('afterSuite'));
      });

      if (this.runner.failures && this.isRetryNeeded()) {
        this.prepareRetry(mocha);
        return mochaRun(mocha);
      } else {
        return result;
      }
    };

    await (0, _utils.executeHooksWithArgs)(this.config.before, [this.capabilities, this.specs]);
    const result = await mochaRun(mocha);
    await (0, _utils.executeHooksWithArgs)(this.config.after, [runtimeError || result, this.capabilities, this.specs]);

    if (runtimeError) {
      throw runtimeError;
    }

    return result;
  }

  skipSuiteIfNeeded() {
    if (this.nextRetry) {
      const suites = this.runner.suite.suites.slice();
      this.runner.suite.suites.some(suite => suite.title === this.nextRetry || !suites.shift());
      this.runner.suite.suites = suites;
      this.nextRetry = null;
    }
  }

  isRetryNeeded() {
    if (this.nextRetry) {
      this.retried[this.nextRetry] = this.retried[this.nextRetry] ? ++this.retried[this.nextRetry] : 1;
      return this.retried[this.nextRetry] < this.retrySuite;
    } else {
      return false;
    }
  }

  prepareRetry(mocha) {
    mocha.files.forEach(file => {
      delete require.cache[file];
    });
    mocha.suite.suites = [];
    this.runner.suite._afterEach = [];
    this.runner.suite._afterAll = [];
    this.runner.suite._beforeAll = [];
    this.runner.suite._beforeEach = [];
  }

  abortNeeded(err, payload) {
    if (err && payload.parent) {
      const title = payload.parent.title;

      if (this.retrySuite && (!this.retried[title] || this.retried[title] < this.retrySuite - 1)) {
        this.nextRetry = title;
        return true;
      }
    }

    return false;
  }

  options(options, context) {
    let {
      require = [],
      compilers = []
    } = options;

    if (typeof require === 'string') {
      require = [require];
    }

    this.requireExternalModules([...compilers, ...require], context);
  }

  preRequire(context, file, mocha) {
    const options = this.config.mochaOpts;
    const match = MOCHA_UI_TYPE_EXTRACTOR.exec(options.ui);
    const type = match && _constants.INTERFACES[match[1]] && match[1] || DEFAULT_INTERFACE_TYPE;

    const hookArgsFn = context => {
      return [_objectSpread({}, context.test, {
        parent: context.test.parent.title
      }), context];
    };

    _constants.INTERFACES[type].forEach(fnName => {
      let testCommand = _constants.INTERFACES[type][0];
      const isTest = [testCommand, testCommand + '.only'].includes(fnName);
      (0, _utils.runTestInFiberContext)(isTest, isTest ? this.config.beforeTest : this.config.beforeHook, hookArgsFn, isTest ? this.config.afterTest : this.config.afterHook, hookArgsFn, fnName, this.cid);
    });

    this.options(options, {
      context,
      file,
      mocha,
      options
    });
  }

  wrapHook(hookName) {
    return () => (0, _utils.executeHooksWithArgs)(this.config[hookName], this.prepareMessage(hookName)).catch(e => {
      log.error(`Error in ${hookName} hook: ${e.stack.slice(7)}`);
    });
  }

  prepareMessage(hookName) {
    const params = {
      type: hookName
    };

    switch (hookName) {
      case 'beforeSuite':
      case 'afterSuite':
        params.payload = this.runner.suite.suites[0];
        break;

      case 'beforeTest':
      case 'afterTest':
        params.payload = this.runner.test;
        break;
    }

    params.err = this.lastError;
    delete this.lastError;
    return this.formatMessage(params);
  }

  formatMessage(params) {
    let message = {
      type: params.type
    };

    if (params.err) {
      message.error = {
        message: params.err.message,
        stack: params.err.stack,
        type: params.err.type || params.err.name,
        expected: params.err.expected,
        actual: params.err.actual
      };

      if (params.payload && params.payload.title && params.payload.title.match(/^"(before|after)( all)*" hook/g)) {
        message.type = 'hook:end';
      }
    }

    if (params.payload) {
      message.title = params.payload.title;
      message.parent = params.payload.parent ? params.payload.parent.title : null;
      message.fullTitle = params.payload.fullTitle ? params.payload.fullTitle() : message.parent + ' ' + message.title;
      message.pending = params.payload.pending || false;
      message.file = params.payload.file;
      message.duration = params.payload.duration;

      if (params.payload.ctx && params.payload.ctx.currentTest) {
        message.currentTest = params.payload.ctx.currentTest.title;
      }

      if (params.type.match(/Test/)) {
        message.passed = params.payload.state === 'passed';
      }

      if (params.payload.context) {
        message.context = params.payload.context;
      }
    }

    return message;
  }

  requireExternalModules(modules, context) {
    modules.forEach(module => {
      if (!module) {
        return;
      }

      module = module.replace(/.*:/, '');

      if (module.substr(0, 1) === '.') {
        module = _path.default.join(process.cwd(), module);
      }

      (0, _utils2.loadModule)(module, context);
    });
  }

  emit(event, payload, err) {
    if (payload.root) return;
    const uid = this.getUID(this.formatMessage({
      type: event,
      payload,
      err
    }));

    if (this.abortNeeded(err, payload)) {
      err = null;
      event = 'test:pending';
      payload.state = undefined;
      payload.pending = true;
      this.runner.abort();
    }

    const message = this.formatMessage({
      type: event,
      payload,
      err
    });

    if (event.match('suite:') && this.retried[message.title]) {
      message.title += ` (retry ${this.retried[message.title]})`;
    }

    if (event.match('test:') && payload.parent && this.retried[payload.parent.title]) {
      message.parent += ` (retry ${this.retried[payload.parent.title]})`;
    }

    message.cid = this.cid;
    message.specs = this.specs;
    message.uid = uid;

    if (message.error) {
      this.lastError = message.error;
    }

    this.reporter.emit(message.type, message);
  }

  getSyncEventIdStart(type) {
    const prop = `${type}Cnt`;
    const suiteId = this.suiteIds[this.suiteIds.length - 1];
    const cnt = this[prop].has(suiteId) ? this[prop].get(suiteId) : 0;
    this[prop].set(suiteId, cnt + 1);
    return `${type}-${suiteId}-${cnt}`;
  }

  getSyncEventIdEnd(type) {
    const prop = `${type}Cnt`;
    const suiteId = this.suiteIds[this.suiteIds.length - 1];
    const cnt = this[prop].get(suiteId) - 1;
    return `${type}-${suiteId}-${cnt}`;
  }

  getUID(message) {
    if (message.type === 'suite:start') {
      const suiteCnt = this.suiteCnt.has(this.level) ? this.suiteCnt.get(this.level) : 0;
      const suiteId = `suite-${this.level}-${suiteCnt}`;

      if (this.suiteCnt.has(this.level)) {
        this.suiteCnt.set(this.level, this.suiteCnt.get(this.level) + 1);
      } else {
        this.suiteCnt.set(this.level, 1);
      }

      this.suiteIds.push(`${this.level}${suiteCnt}`);
      this.level++;
      return suiteId;
    }

    if (message.type === 'suite:end') {
      this.level--;
      const suiteCnt = this.suiteCnt.get(this.level) - 1;
      const suiteId = `suite-${this.level}-${suiteCnt}`;
      this.suiteIds.pop();
      return suiteId;
    }

    if (message.type === 'hook:start') {
      return this.getSyncEventIdStart('hook');
    }

    if (message.type === 'hook:end') {
      return this.getSyncEventIdEnd('hook');
    }

    if (['test:start', 'test:pending'].includes(message.type)) {
      return this.getSyncEventIdStart('test');
    }

    if (['test:end', 'test:pass', 'test:fail'].includes(message.type)) {
      return this.getSyncEventIdEnd('test');
    }

    throw new Error(`Unknown message type : ${message.type}`);
  }

}

exports.MochaAdapter = MochaAdapter;
const adapterFactory = {};
exports.adapterFactory = adapterFactory;

adapterFactory.init = async function (...args) {
  const adapter = new MochaAdapter(...args);
  const instance = await adapter.init();
  return instance;
};

var _default = adapterFactory;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2ciLCJNT0NIQV9VSV9UWVBFX0VYVFJBQ1RPUiIsIkRFRkFVTFRfSU5URVJGQUNFX1RZUEUiLCJNb2NoYUFkYXB0ZXIiLCJjb25zdHJ1Y3RvciIsImNpZCIsImNvbmZpZyIsInNwZWNzIiwiY2FwYWJpbGl0aWVzIiwicmVwb3J0ZXIiLCJPYmplY3QiLCJhc3NpZ24iLCJtb2NoYU9wdHMiLCJydW5uZXIiLCJsZXZlbCIsInN1aXRlQ250IiwiTWFwIiwiaG9va0NudCIsInRlc3RDbnQiLCJzdWl0ZUlkcyIsInJldHJ5U3VpdGUiLCJyZXRyaWVkIiwibmV4dFJldHJ5IiwicnVudGltZUVycm9yIiwiX2hhc1Rlc3RzIiwiaW5pdCIsIm1vY2hhIiwiTW9jaGEiLCJsb2FkRmlsZXMiLCJOT09QIiwiZnVsbFRyYWNlIiwiZm9yRWFjaCIsInNwZWMiLCJhZGRGaWxlIiwic3VpdGUiLCJvbiIsInByZVJlcXVpcmUiLCJfbG9hZEZpbGVzIiwiZmVhdHVyZUZsYWdzIiwic3BlY0ZpbHRlcmluZyIsIm1vY2hhUnVubmVyIiwiUnVubmVyIiwiZ3JlcCIsIm9wdGlvbnMiLCJpbnZlcnQiLCJ0b3RhbCIsImVyciIsIndhcm4iLCJqb2luIiwiaGFzVGVzdHMiLCJydW4iLCJtb2NoYVJ1biIsInJlc3VsdCIsIlByb21pc2UiLCJyZXNvbHZlIiwiZSIsImtleXMiLCJFVkVOVFMiLCJlbWl0IiwiYmluZCIsInNraXBTdWl0ZUlmTmVlZGVkIiwiYmVmb3JlQWxsIiwid3JhcEhvb2siLCJhZnRlckFsbCIsImZhaWx1cmVzIiwiaXNSZXRyeU5lZWRlZCIsInByZXBhcmVSZXRyeSIsImJlZm9yZSIsImFmdGVyIiwic3VpdGVzIiwic2xpY2UiLCJzb21lIiwidGl0bGUiLCJzaGlmdCIsImZpbGVzIiwiZmlsZSIsInJlcXVpcmUiLCJjYWNoZSIsIl9hZnRlckVhY2giLCJfYWZ0ZXJBbGwiLCJfYmVmb3JlQWxsIiwiX2JlZm9yZUVhY2giLCJhYm9ydE5lZWRlZCIsInBheWxvYWQiLCJwYXJlbnQiLCJjb250ZXh0IiwiY29tcGlsZXJzIiwicmVxdWlyZUV4dGVybmFsTW9kdWxlcyIsIm1hdGNoIiwiZXhlYyIsInVpIiwidHlwZSIsIklOVEVSRkFDRVMiLCJob29rQXJnc0ZuIiwidGVzdCIsImZuTmFtZSIsInRlc3RDb21tYW5kIiwiaXNUZXN0IiwiaW5jbHVkZXMiLCJiZWZvcmVUZXN0IiwiYmVmb3JlSG9vayIsImFmdGVyVGVzdCIsImFmdGVySG9vayIsImhvb2tOYW1lIiwicHJlcGFyZU1lc3NhZ2UiLCJjYXRjaCIsImVycm9yIiwic3RhY2siLCJwYXJhbXMiLCJsYXN0RXJyb3IiLCJmb3JtYXRNZXNzYWdlIiwibWVzc2FnZSIsIm5hbWUiLCJleHBlY3RlZCIsImFjdHVhbCIsImZ1bGxUaXRsZSIsInBlbmRpbmciLCJkdXJhdGlvbiIsImN0eCIsImN1cnJlbnRUZXN0IiwicGFzc2VkIiwic3RhdGUiLCJtb2R1bGVzIiwibW9kdWxlIiwicmVwbGFjZSIsInN1YnN0ciIsInBhdGgiLCJwcm9jZXNzIiwiY3dkIiwiZXZlbnQiLCJyb290IiwidWlkIiwiZ2V0VUlEIiwidW5kZWZpbmVkIiwiYWJvcnQiLCJnZXRTeW5jRXZlbnRJZFN0YXJ0IiwicHJvcCIsInN1aXRlSWQiLCJsZW5ndGgiLCJjbnQiLCJoYXMiLCJnZXQiLCJzZXQiLCJnZXRTeW5jRXZlbnRJZEVuZCIsInB1c2giLCJwb3AiLCJFcnJvciIsImFkYXB0ZXJGYWN0b3J5IiwiYXJncyIsImFkYXB0ZXIiLCJpbnN0YW5jZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUcscUJBQU8sdUJBQVAsQ0FBWjtBQVdBLE1BQU1DLHVCQUF1QixHQUFHLDRCQUFoQztBQUNBLE1BQU1DLHNCQUFzQixHQUFHLEtBQS9COztBQUtBLE1BQU1DLFlBQU4sQ0FBbUI7QUFDZkMsRUFBQUEsV0FB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QStCN0MsUUFBL0IsQ0FBd0NhLE9BQU8sQ0FBQ3BCLElBQWhELENBQUosRUFBMkQ7QUFDdkQsYUFBTyxLQUFLNEMsbUJBQUwsQ0FBeUIsTUFBekIsQ0FBUDtBQUNIOztBQUNELFFBQUksQ0FBQyxVQUFELEVBQWEsV0FBYixFQUEwQixXQUExQixFQUF1Q3JDLFFBQXZDLENBQWdEYSxPQUFPLENBQUNwQixJQUF4RCxDQUFKLEVBQW1FO0FBQy9ELGFBQU8sS0FBS29ELGlCQUFMLENBQXVCLE1BQXZCLENBQVA7QUFDSDs7QUFFRCxVQUFNLElBQUlHLEtBQUosQ0FBVywwQkFBeUJuQyxPQUFPLENBQUNwQixJQUFLLEVBQWpELENBQU47QUFDSDs7QUFuWWM7OztBQXNZbkIsTUFBTXdELGNBQWMsR0FBRyxFQUF2Qjs7O0FBRUFBLGNBQWMsQ0FBQzFILElBQWYsR0FBc0IsZ0JBQWdCLEdBQUcySCxJQUFuQixFQUF5QjtBQUMzQyxRQUFNQyxPQUFPLEdBQUcsSUFBSWxKLFlBQUosQ0FBaUIsR0FBR2lKLElBQXBCLENBQWhCO0FBQ0EsUUFBTUUsUUFBUSxHQUFHLE1BQU1ELE9BQU8sQ0FBQzVILElBQVIsRUFBdkI7QUFDQSxTQUFPNkgsUUFBUDtBQUNILENBSkQ7O2VBTWVILGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IE1vY2hhIGZyb20gJ21vY2hhJ1xuXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCB7IHJ1blRlc3RJbkZpYmVyQ29udGV4dCwgZXhlY3V0ZUhvb2tzV2l0aEFyZ3MgfSBmcm9tICdAd2Rpby91dGlscydcblxuaW1wb3J0IHsgbG9hZE1vZHVsZSB9IGZyb20gJy4vdXRpbHMnXG5pbXBvcnQgeyBJTlRFUkZBQ0VTLCBFVkVOVFMsIE5PT1AgfSBmcm9tICcuL2NvbnN0YW50cydcblxuY29uc3QgbG9nID0gbG9nZ2VyKCdAd2Rpby9tb2NoYS1mcmFtZXdvcmsnKVxuXG4vKipcbiogRXh0cmFjdHMgdGhlIG1vY2hhIFVJIHR5cGUgZm9sbG93aW5nIHRoaXMgY29udmVudGlvbjpcbiogIC0gSWYgdGhlIG1vY2hhT3B0cy51aSBwcm92aWRlZCBkb2Vzbid0IGNvbnRhaW4gYSAnLScgdGhlbiB0aGUgZnVsbCBuYW1lXG4qICAgICAgaXMgdGFrZW4gYXMgdWkgdHlwZSAoaS5lLiAnYmRkJywndGRkJywncXVuaXQnKVxuKiAgLSBJZiBpdCBjb250YWlucyBhICctJyB0aGVuIGl0IGFzdW1lcyB3ZSBhcmUgcHJvdmlkaW5nIGEgY3VzdG9tIHVpIGZvclxuKiAgICAgIG1vY2hhLiBUaGVuIGl0IGV4dHJhY3RzIHRoZSB0ZXh0IGFmdGVyIHRoZSBsYXN0ICctJyAoaWdub3JpbmcgLmpzIGlmXG4qICAgICAgcHJvdmlkZWQpIGFzIHRoZSBpbnRlcmZhY2UgdHlwZS4gKGkuZS4gc3Ryb25nLWJkZCBpblxuKiAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9zdHJvbmdsb29wL3N0cm9uZy1tb2NoYS1pbnRlcmZhY2VzKVxuKi9cbmNvbnN0IE1PQ0hBX1VJX1RZUEVfRVhUUkFDVE9SID0gL14oPzouKi0pPyhbXi0uXSspKD86LmpzKT8kL1xuY29uc3QgREVGQVVMVF9JTlRFUkZBQ0VfVFlQRSA9ICdiZGQnXG5cbi8qKlxuICogTW9jaGEgcnVubmVyXG4gKi9cbmNsYXNzIE1vY2hhQWRhcHRlciB7XG4gICAgY29uc3RydWN0b3IgKGNpZCwgY29uZmlnLCBzcGVjcywgY2FwYWJpbGl0aWVzLCByZXBvcnRlcikge1xuICAgICAgICB0aGlzLmNpZCA9IGNpZFxuICAgICAgICB0aGlzLmNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdGllc1xuICAgICAgICB0aGlzLnJlcG9ydGVyID0gcmVwb3J0ZXJcbiAgICAgICAgdGhpcy5zcGVjcyA9IHNwZWNzXG4gICAgICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgICBtb2NoYU9wdHM6IHt9XG4gICAgICAgIH0sIGNvbmZpZylcbiAgICAgICAgdGhpcy5ydW5uZXIgPSB7fVxuICAgICAgICB0aGlzLmxldmVsID0gMFxuICAgICAgICB0aGlzLnN1aXRlQ250ID0gbmV3IE1hcCgpXG4gICAgICAgIHRoaXMuaG9va0NudCA9IG5ldyBNYXAoKVxuICAgICAgICB0aGlzLnRlc3RDbnQgPSBuZXcgTWFwKClcbiAgICAgICAgdGhpcy5zdWl0ZUlkcyA9IFsnMCddXG4gICAgICAgIHRoaXMucmV0cnlTdWl0ZSA9IHRoaXMuY29uZmlnLm1vY2hhT3B0cy5yZXRyeVN1aXRlIHx8IDBcbiAgICAgICAgdGhpcy5yZXRyaWVkID0ge31cbiAgICAgICAgdGhpcy5uZXh0UmV0cnkgPSBudWxsXG4gICAgICAgIHRoaXMucnVudGltZUVycm9yID0gbnVsbFxuICAgICAgICB0aGlzLl9oYXNUZXN0cyA9IHRydWVcbiAgICB9XG5cbiAgICBhc3luYyBpbml0ICgpIHtcbiAgICAgICAgY29uc3QgeyBtb2NoYU9wdHMgfSA9IHRoaXMuY29uZmlnXG4gICAgICAgIGNvbnN0IG1vY2hhID0gdGhpcy5tb2NoYSA9IG5ldyBNb2NoYShtb2NoYU9wdHMpXG4gICAgICAgIG1vY2hhLmxvYWRGaWxlcygpXG4gICAgICAgIG1vY2hhLnJlcG9ydGVyKE5PT1ApXG4gICAgICAgIG1vY2hhLmZ1bGxUcmFjZSgpXG5cbiAgICAgICAgdGhpcy5zcGVjcy5mb3JFYWNoKChzcGVjKSA9PiBtb2NoYS5hZGRGaWxlKHNwZWMpKVxuICAgICAgICBtb2NoYS5zdWl0ZS5vbigncHJlLXJlcXVpcmUnLCA6OnRoaXMucHJlUmVxdWlyZSlcbiAgICAgICAgdGhpcy5fbG9hZEZpbGVzKG1vY2hhT3B0cylcblxuICAgICAgICByZXR1cm4gdGhpc1xuICAgIH1cblxuICAgIF9sb2FkRmlsZXMgKG1vY2hhT3B0cykge1xuICAgICAgICBpZiAodGhpcy5jb25maWcuZmVhdHVyZUZsYWdzLnNwZWNGaWx0ZXJpbmcgIT09IHRydWUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLm1vY2hhLmxvYWRGaWxlcygpXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogZ3JlcFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBjb25zdCBtb2NoYVJ1bm5lciA9IG5ldyBNb2NoYS5SdW5uZXIodGhpcy5tb2NoYS5zdWl0ZSlcbiAgICAgICAgICAgIGlmIChtb2NoYU9wdHMuZ3JlcCkge1xuICAgICAgICAgICAgICAgIG1vY2hhUnVubmVyLmdyZXAodGhpcy5tb2NoYS5vcHRpb25zLmdyZXAsIG1vY2hhT3B0cy5pbnZlcnQpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX2hhc1Rlc3RzID0gbW9jaGFSdW5uZXIudG90YWwgPiAwXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nLndhcm4oXG4gICAgICAgICAgICAgICAgJ1VuYWJsZSB0byBsb2FkIHNwZWMgZmlsZXMgcXVpdGUgbGlrZWx5IGJlY2F1c2UgdGhleSByZWx5IG9uIGBicm93c2VyYCBvYmplY3QgdGhhdCBpcyBub3QgZnVsbHkgaW5pdGlhbGlzZWQuXFxuJyArXG4gICAgICAgICAgICAgICAgJ2Bicm93c2VyYCBvYmplY3QgaGFzIG9ubHkgYGNhcGFiaWxpdGllc2AgYW5kIHNvbWUgZmxhZ3MgbGlrZSBgaXNNb2JpbGVgLlxcbicgK1xuICAgICAgICAgICAgICAgICdIZWxwZXIgZmlsZXMgdGhhdCB1c2Ugb3RoZXIgYGJyb3dzZXJgIGNvbW1hbmRzIGhhdmUgdG8gYmUgbW92ZWQgdG8gYGJlZm9yZWAgaG9vay5cXG4nICtcbiAgICAgICAgICAgICAgICBgU3BlYyBmaWxlKHMpOiAke3RoaXMuc3BlY3Muam9pbignLCcpfVxcbmAsXG4gICAgICAgICAgICAgICAgJ0Vycm9yOiAnLCBlcnJcbiAgICAgICAgICAgIClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGhhc1Rlc3RzICgpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIGZpbHRlciBzcGVjcyBvbmx5IGlmIGZlYXR1cmUgZW5hYmxlZCBleHBsaWNpdGx5IHRvIGF2b2lkIGJyZWFraW5nIGNoYW5nZXMuXG4gICAgICAgICAqIElmIHRoZSBmZWF0dXJlIGlzIGVuYWJsZWQgdXNlciBzaG91bGQgYXZvaWQgaW50ZXJhY3Rpbmcgd2l0aCBgYnJvd3NlcmAgb2JqZWN0IGJlZm9yZSBzZXNzaW9uIGlzIHN0YXJ0ZWRcbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5mZWF0dXJlRmxhZ3Muc3BlY0ZpbHRlcmluZyAhPT0gdHJ1ZSB8fCB0aGlzLl9oYXNUZXN0c1xuICAgIH1cblxuICAgIGFzeW5jIHJ1biAoKSB7XG4gICAgICAgIGNvbnN0IG1vY2hhID0gdGhpcy5tb2NoYVxuICAgICAgICBsZXQgcnVudGltZUVycm9yXG5cbiAgICAgICAgY29uc3QgbW9jaGFSdW4gPSBhc3luYyAobW9jaGEpID0+IHtcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgdGhpcy5ydW5uZXIgPSBtb2NoYS5ydW4ocmVzb2x2ZSlcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgcnVudGltZUVycm9yID0gZVxuICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgxKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhFVkVOVFMpLmZvckVhY2goKGUpID0+XG4gICAgICAgICAgICAgIHRoaXMucnVubmVyLm9uKGUsIHRoaXMuZW1pdC5iaW5kKHRoaXMsIEVWRU5UU1tlXSkpKVxuXG4gICAgICAgICAgICB0aGlzLnNraXBTdWl0ZUlmTmVlZGVkKClcbiAgICAgICAgICAgIHRoaXMucnVubmVyLnN1aXRlLmJlZm9yZUFsbCh0aGlzLndyYXBIb29rKCdiZWZvcmVTdWl0ZScpKVxuICAgICAgICAgICAgdGhpcy5ydW5uZXIuc3VpdGUuYWZ0ZXJBbGwodGhpcy53cmFwSG9vaygnYWZ0ZXJTdWl0ZScpKVxuICAgICAgICAgIH0pXG5cbiAgICAgICAgICBpZiAodGhpcy5ydW5uZXIuZmFpbHVyZXMgJiYgdGhpcy5pc1JldHJ5TmVlZGVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMucHJlcGFyZVJldHJ5KG1vY2hhKVxuICAgICAgICAgICAgcmV0dXJuIG1vY2hhUnVuKG1vY2hhKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgZXhlY3V0ZUhvb2tzV2l0aEFyZ3ModGhpcy5jb25maWcuYmVmb3JlLCBbdGhpcy5jYXBhYmlsaXRpZXMsIHRoaXMuc3BlY3NdKVxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBtb2NoYVJ1bihtb2NoYSlcbiAgICAgICAgYXdhaXQgZXhlY3V0ZUhvb2tzV2l0aEFyZ3ModGhpcy5jb25maWcuYWZ0ZXIsIFtydW50aW1lRXJyb3IgfHwgcmVzdWx0LCB0aGlzLmNhcGFiaWxpdGllcywgdGhpcy5zcGVjc10pXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGluIGNhc2UgdGhlIHNwZWMgaGFzIGEgcnVudGltZSBlcnJvciB0aHJvdyBhZnRlciB0aGUgd2RpbyBob29rXG4gICAgICAgICAqL1xuICAgICAgICBpZiAocnVudGltZUVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBydW50aW1lRXJyb3JcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHRcbiAgICB9XG5cbiAgICBza2lwU3VpdGVJZk5lZWRlZCgpIHtcbiAgICAgICAgaWYgKHRoaXMubmV4dFJldHJ5KSB7XG4gICAgICAgICAgICAvLyByZW1vdmUgc3VpdGVzIHVudGlsIHdlIGFyZSB0byB0aGUgc3VpdGUgdG8gcmV0cnlcbiAgICAgICAgICAgIC8vIHdlIGNhbid0IHJlYWNoIGEgc3VpdGUgd2l0aG91dCBiZWluZyBvayBvbiB0aGUgcHJldmlvdXMgb25lXG4gICAgICAgICAgICBjb25zdCBzdWl0ZXMgPSB0aGlzLnJ1bm5lci5zdWl0ZS5zdWl0ZXMuc2xpY2UoKVxuICAgICAgICAgICAgdGhpcy5ydW5uZXIuc3VpdGUuc3VpdGVzLnNvbWUoc3VpdGUgPT4gc3VpdGUudGl0bGUgPT09IHRoaXMubmV4dFJldHJ5IHx8ICFzdWl0ZXMuc2hpZnQoKSlcbiAgICAgICAgICAgIHRoaXMucnVubmVyLnN1aXRlLnN1aXRlcyA9IHN1aXRlc1xuICAgICAgICAgICAgdGhpcy5uZXh0UmV0cnkgPSBudWxsXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc1JldHJ5TmVlZGVkKCkge1xuICAgICAgICBpZiAodGhpcy5uZXh0UmV0cnkpIHtcbiAgICAgICAgICAgIHRoaXMucmV0cmllZFt0aGlzLm5leHRSZXRyeV0gPSB0aGlzLnJldHJpZWRbdGhpcy5uZXh0UmV0cnldID8gKyt0aGlzLnJldHJpZWRbdGhpcy5uZXh0UmV0cnldIDogMVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV0cmllZFt0aGlzLm5leHRSZXRyeV0gPCB0aGlzLnJldHJ5U3VpdGVcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJlcGFyZVJldHJ5KG1vY2hhKSB7XG4gICAgICAgIG1vY2hhLmZpbGVzLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVtmaWxlXVxuICAgICAgICB9KVxuICAgICAgICBtb2NoYS5zdWl0ZS5zdWl0ZXMgPSBbXVxuICAgICAgICB0aGlzLnJ1bm5lci5zdWl0ZS5fYWZ0ZXJFYWNoID0gW11cbiAgICAgICAgdGhpcy5ydW5uZXIuc3VpdGUuX2FmdGVyQWxsID0gW11cbiAgICAgICAgdGhpcy5ydW5uZXIuc3VpdGUuX2JlZm9yZUFsbCA9IFtdXG4gICAgICAgIHRoaXMucnVubmVyLnN1aXRlLl9iZWZvcmVFYWNoID0gW11cbiAgICB9XG5cbiAgICBhYm9ydE5lZWRlZChlcnIsIHBheWxvYWQpIHtcbiAgICAgICAgaWYgKGVyciAmJiBwYXlsb2FkLnBhcmVudCkge1xuICAgICAgICAgICAgY29uc3QgdGl0bGUgPSBwYXlsb2FkLnBhcmVudC50aXRsZVxuICAgICAgICAgICAgaWYgKHRoaXMucmV0cnlTdWl0ZSAmJlxuICAgICAgICAgICAgICAgICghdGhpcy5yZXRyaWVkW3RpdGxlXSB8fCB0aGlzLnJldHJpZWRbdGl0bGVdIDwgKHRoaXMucmV0cnlTdWl0ZSAtIDEpKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uZXh0UmV0cnkgPSB0aXRsZVxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgb3B0aW9ucyAob3B0aW9ucywgY29udGV4dCkge1xuICAgICAgICBsZXQgeyByZXF1aXJlID0gW10sIGNvbXBpbGVycyA9IFtdIH0gPSBvcHRpb25zXG5cbiAgICAgICAgaWYgKHR5cGVvZiByZXF1aXJlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmVxdWlyZSA9IFtyZXF1aXJlXVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXF1aXJlRXh0ZXJuYWxNb2R1bGVzKFsuLi5jb21waWxlcnMsIC4uLnJlcXVpcmVdLCBjb250ZXh0KVxuICAgIH1cblxuICAgIHByZVJlcXVpcmUgKGNvbnRleHQsIGZpbGUsIG1vY2hhKSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmNvbmZpZy5tb2NoYU9wdHNcblxuICAgICAgICBjb25zdCBtYXRjaCA9IE1PQ0hBX1VJX1RZUEVfRVhUUkFDVE9SLmV4ZWMob3B0aW9ucy51aSlcbiAgICAgICAgY29uc3QgdHlwZSA9IChtYXRjaCAmJiBJTlRFUkZBQ0VTW21hdGNoWzFdXSAmJiBtYXRjaFsxXSkgfHwgREVGQVVMVF9JTlRFUkZBQ0VfVFlQRVxuXG4gICAgICAgIGNvbnN0IGhvb2tBcmdzRm4gPSAoY29udGV4dCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFt7IC4uLmNvbnRleHQudGVzdCwgcGFyZW50OiBjb250ZXh0LnRlc3QucGFyZW50LnRpdGxlIH0sIGNvbnRleHRdXG4gICAgICAgIH1cblxuICAgICAgICBJTlRFUkZBQ0VTW3R5cGVdLmZvckVhY2goKGZuTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHRlc3RDb21tYW5kID0gSU5URVJGQUNFU1t0eXBlXVswXVxuICAgICAgICAgICAgY29uc3QgaXNUZXN0ID0gW3Rlc3RDb21tYW5kLCB0ZXN0Q29tbWFuZCArICcub25seSddLmluY2x1ZGVzKGZuTmFtZSlcblxuICAgICAgICAgICAgcnVuVGVzdEluRmliZXJDb250ZXh0KFxuICAgICAgICAgICAgICAgIGlzVGVzdCxcbiAgICAgICAgICAgICAgICBpc1Rlc3QgPyB0aGlzLmNvbmZpZy5iZWZvcmVUZXN0IDogdGhpcy5jb25maWcuYmVmb3JlSG9vayxcbiAgICAgICAgICAgICAgICBob29rQXJnc0ZuLFxuICAgICAgICAgICAgICAgIGlzVGVzdCA/IHRoaXMuY29uZmlnLmFmdGVyVGVzdCA6IHRoaXMuY29uZmlnLmFmdGVySG9vayxcbiAgICAgICAgICAgICAgICBob29rQXJnc0ZuLFxuICAgICAgICAgICAgICAgIGZuTmFtZSxcbiAgICAgICAgICAgICAgICB0aGlzLmNpZFxuICAgICAgICAgICAgKVxuICAgICAgICB9KVxuICAgICAgICB0aGlzLm9wdGlvbnMob3B0aW9ucywgeyBjb250ZXh0LCBmaWxlLCBtb2NoYSwgb3B0aW9ucyB9KVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhvb2tzIHdoaWNoIGFyZSBhZGRlZCBhcyB0cnVlIE1vY2hhIGhvb2tzIG5lZWQgdG8gY2FsbCBkb25lKCkgdG8gbm90aWZ5IGFzeW5jXG4gICAgICovXG4gICAgd3JhcEhvb2sgKGhvb2tOYW1lKSB7XG4gICAgICAgIHJldHVybiAoKSA9PiBleGVjdXRlSG9va3NXaXRoQXJncyhcbiAgICAgICAgICAgIHRoaXMuY29uZmlnW2hvb2tOYW1lXSxcbiAgICAgICAgICAgIHRoaXMucHJlcGFyZU1lc3NhZ2UoaG9va05hbWUpXG4gICAgICAgICkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIGxvZy5lcnJvcihgRXJyb3IgaW4gJHtob29rTmFtZX0gaG9vazogJHtlLnN0YWNrLnNsaWNlKDcpfWApXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgcHJlcGFyZU1lc3NhZ2UgKGhvb2tOYW1lKSB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHsgdHlwZTogaG9va05hbWUgfVxuXG4gICAgICAgIHN3aXRjaCAoaG9va05hbWUpIHtcbiAgICAgICAgY2FzZSAnYmVmb3JlU3VpdGUnOlxuICAgICAgICBjYXNlICdhZnRlclN1aXRlJzpcbiAgICAgICAgICAgIHBhcmFtcy5wYXlsb2FkID0gdGhpcy5ydW5uZXIuc3VpdGUuc3VpdGVzWzBdXG4gICAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdiZWZvcmVUZXN0JzpcbiAgICAgICAgY2FzZSAnYWZ0ZXJUZXN0JzpcbiAgICAgICAgICAgIHBhcmFtcy5wYXlsb2FkID0gdGhpcy5ydW5uZXIudGVzdFxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuXG4gICAgICAgIHBhcmFtcy5lcnIgPSB0aGlzLmxhc3RFcnJvclxuICAgICAgICBkZWxldGUgdGhpcy5sYXN0RXJyb3JcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0TWVzc2FnZShwYXJhbXMpXG4gICAgfVxuXG4gICAgZm9ybWF0TWVzc2FnZSAocGFyYW1zKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0ge1xuICAgICAgICAgICAgdHlwZTogcGFyYW1zLnR5cGVcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYXJhbXMuZXJyKSB7XG4gICAgICAgICAgICBtZXNzYWdlLmVycm9yID0ge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHBhcmFtcy5lcnIubWVzc2FnZSxcbiAgICAgICAgICAgICAgICBzdGFjazogcGFyYW1zLmVyci5zdGFjayxcbiAgICAgICAgICAgICAgICB0eXBlOiBwYXJhbXMuZXJyLnR5cGUgfHwgcGFyYW1zLmVyci5uYW1lLFxuICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBwYXJhbXMuZXJyLmV4cGVjdGVkLFxuICAgICAgICAgICAgICAgIGFjdHVhbDogcGFyYW1zLmVyci5hY3R1YWxcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBob29rIGZhaWx1cmVzIGFyZSBlbWl0dGVkIGFzIFwidGVzdDpmYWlsXCJcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKHBhcmFtcy5wYXlsb2FkICYmIHBhcmFtcy5wYXlsb2FkLnRpdGxlICYmIHBhcmFtcy5wYXlsb2FkLnRpdGxlLm1hdGNoKC9eXCIoYmVmb3JlfGFmdGVyKSggYWxsKSpcIiBob29rL2cpKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gJ2hvb2s6ZW5kJ1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhcmFtcy5wYXlsb2FkKSB7XG4gICAgICAgICAgICBtZXNzYWdlLnRpdGxlID0gcGFyYW1zLnBheWxvYWQudGl0bGVcbiAgICAgICAgICAgIG1lc3NhZ2UucGFyZW50ID0gcGFyYW1zLnBheWxvYWQucGFyZW50ID8gcGFyYW1zLnBheWxvYWQucGFyZW50LnRpdGxlIDogbnVsbFxuXG4gICAgICAgICAgICBtZXNzYWdlLmZ1bGxUaXRsZSA9IHBhcmFtcy5wYXlsb2FkLmZ1bGxUaXRsZSA/IHBhcmFtcy5wYXlsb2FkLmZ1bGxUaXRsZSgpIDogbWVzc2FnZS5wYXJlbnQgKyAnICcgKyBtZXNzYWdlLnRpdGxlXG4gICAgICAgICAgICBtZXNzYWdlLnBlbmRpbmcgPSBwYXJhbXMucGF5bG9hZC5wZW5kaW5nIHx8IGZhbHNlXG4gICAgICAgICAgICBtZXNzYWdlLmZpbGUgPSBwYXJhbXMucGF5bG9hZC5maWxlXG4gICAgICAgICAgICBtZXNzYWdlLmR1cmF0aW9uID0gcGFyYW1zLnBheWxvYWQuZHVyYXRpb25cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBBZGQgdGhlIGN1cnJlbnQgdGVzdCB0aXRsZSB0byB0aGUgcGF5bG9hZCBmb3IgY2FzZXMgd2hlcmUgaXQgaGVscHMgdG9cbiAgICAgICAgICAgICAqIGlkZW50aWZ5IHRoZSB0ZXN0LCBlLmcuIHdoZW4gcnVubmluZyBpbnNpZGUgYSBiZWZvcmVFYWNoIGhvb2tcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKHBhcmFtcy5wYXlsb2FkLmN0eCAmJiBwYXJhbXMucGF5bG9hZC5jdHguY3VycmVudFRlc3QpIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlLmN1cnJlbnRUZXN0ID0gcGFyYW1zLnBheWxvYWQuY3R4LmN1cnJlbnRUZXN0LnRpdGxlXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwYXJhbXMudHlwZS5tYXRjaCgvVGVzdC8pKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZS5wYXNzZWQgPSAocGFyYW1zLnBheWxvYWQuc3RhdGUgPT09ICdwYXNzZWQnKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGFyYW1zLnBheWxvYWQuY29udGV4dCkgeyBtZXNzYWdlLmNvbnRleHQgPSBwYXJhbXMucGF5bG9hZC5jb250ZXh0IH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtZXNzYWdlXG4gICAgfVxuXG4gICAgcmVxdWlyZUV4dGVybmFsTW9kdWxlcyAobW9kdWxlcywgY29udGV4dCkge1xuICAgICAgICBtb2R1bGVzLmZvckVhY2gobW9kdWxlID0+IHtcbiAgICAgICAgICAgIGlmICghbW9kdWxlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG1vZHVsZSA9IG1vZHVsZS5yZXBsYWNlKC8uKjovLCAnJylcblxuICAgICAgICAgICAgaWYgKG1vZHVsZS5zdWJzdHIoMCwgMSkgPT09ICcuJykge1xuICAgICAgICAgICAgICAgIG1vZHVsZSA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBtb2R1bGUpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxvYWRNb2R1bGUobW9kdWxlLCBjb250ZXh0KVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGVtaXQgKGV2ZW50LCBwYXlsb2FkLCBlcnIpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZvciBzb21lIHJlYXNvbiwgTW9jaGEgZmlyZXMgYSBzZWNvbmQgJ3N1aXRlOmVuZCcgZXZlbnQgZm9yIHRoZSByb290IHN1aXRlLFxuICAgICAgICAgKiB3aXRoIG5vIG1hdGNoaW5nICdzdWl0ZTpzdGFydCcsIHNvIHRoaXMgY2FuIGJlIGlnbm9yZWQuXG4gICAgICAgICAqL1xuICAgICAgICBpZiAocGF5bG9hZC5yb290KSByZXR1cm5cblxuICAgICAgICBjb25zdCB1aWQgPSB0aGlzLmdldFVJRCh0aGlzLmZvcm1hdE1lc3NhZ2UoeyB0eXBlOiBldmVudCwgcGF5bG9hZCwgZXJyIH0pKVxuXG4gICAgICAgIC8vIGlmIGFuIGVycm9yIGFwcGVuZCwgYW5kIHJldHJ5U3VpdGUgaXMgc2V0dGVkXG4gICAgICAgIC8vIHdlIG11c3QgYWJvcnQgdGhlIHByb2Nlc3Mgbm93IGFuZCByZXRyeSB0aGUgc3BlY1xuICAgICAgICBpZiAodGhpcy5hYm9ydE5lZWRlZChlcnIsIHBheWxvYWQpKSB7XG4gICAgICAgICAgICBlcnIgPSBudWxsXG4gICAgICAgICAgICBldmVudCA9ICd0ZXN0OnBlbmRpbmcnXG4gICAgICAgICAgICBwYXlsb2FkLnN0YXRlID0gdW5kZWZpbmVkXG4gICAgICAgICAgICBwYXlsb2FkLnBlbmRpbmcgPSB0cnVlXG4gICAgICAgICAgICB0aGlzLnJ1bm5lci5hYm9ydCgpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5mb3JtYXRNZXNzYWdlKHsgdHlwZTogZXZlbnQsIHBheWxvYWQsIGVyciB9KVxuXG4gICAgICAgIGlmIChldmVudC5tYXRjaCgnc3VpdGU6JykgJiYgdGhpcy5yZXRyaWVkW21lc3NhZ2UudGl0bGVdKSB7XG4gICAgICAgICAgICBtZXNzYWdlLnRpdGxlICs9IGAgKHJldHJ5ICR7dGhpcy5yZXRyaWVkW21lc3NhZ2UudGl0bGVdfSlgXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXZlbnQubWF0Y2goJ3Rlc3Q6JykgJiYgcGF5bG9hZC5wYXJlbnQgJiYgdGhpcy5yZXRyaWVkW3BheWxvYWQucGFyZW50LnRpdGxlXSkge1xuICAgICAgICAgICAgbWVzc2FnZS5wYXJlbnQgKz0gYCAocmV0cnkgJHt0aGlzLnJldHJpZWRbcGF5bG9hZC5wYXJlbnQudGl0bGVdfSlgXG4gICAgICAgIH1cblxuICAgICAgICBtZXNzYWdlLmNpZCA9IHRoaXMuY2lkXG4gICAgICAgIG1lc3NhZ2Uuc3BlY3MgPSB0aGlzLnNwZWNzXG4gICAgICAgIG1lc3NhZ2UudWlkID0gdWlkXG5cbiAgICAgICAgaWYgKG1lc3NhZ2UuZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gbWVzc2FnZS5lcnJvclxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXBvcnRlci5lbWl0KG1lc3NhZ2UudHlwZSwgbWVzc2FnZSlcbiAgICB9XG5cbiAgICBnZXRTeW5jRXZlbnRJZFN0YXJ0ICh0eXBlKSB7XG4gICAgICAgIGNvbnN0IHByb3AgPSBgJHt0eXBlfUNudGBcbiAgICAgICAgY29uc3Qgc3VpdGVJZCA9IHRoaXMuc3VpdGVJZHNbdGhpcy5zdWl0ZUlkcy5sZW5ndGggLSAxXVxuICAgICAgICBjb25zdCBjbnQgPSB0aGlzW3Byb3BdLmhhcyhzdWl0ZUlkKVxuICAgICAgICAgICAgPyB0aGlzW3Byb3BdLmdldChzdWl0ZUlkKVxuICAgICAgICAgICAgOiAwXG4gICAgICAgIHRoaXNbcHJvcF0uc2V0KHN1aXRlSWQsIGNudCArIDEpXG4gICAgICAgIHJldHVybiBgJHt0eXBlfS0ke3N1aXRlSWR9LSR7Y250fWBcbiAgICB9XG5cbiAgICBnZXRTeW5jRXZlbnRJZEVuZCAodHlwZSkge1xuICAgICAgICBjb25zdCBwcm9wID0gYCR7dHlwZX1DbnRgXG4gICAgICAgIGNvbnN0IHN1aXRlSWQgPSB0aGlzLnN1aXRlSWRzW3RoaXMuc3VpdGVJZHMubGVuZ3RoIC0gMV1cbiAgICAgICAgY29uc3QgY250ID0gdGhpc1twcm9wXS5nZXQoc3VpdGVJZCkgLSAxXG4gICAgICAgIHJldHVybiBgJHt0eXBlfS0ke3N1aXRlSWR9LSR7Y250fWBcbiAgICB9XG5cbiAgICBnZXRVSUQgKG1lc3NhZ2UpIHtcbiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ3N1aXRlOnN0YXJ0Jykge1xuICAgICAgICAgICAgY29uc3Qgc3VpdGVDbnQgPSB0aGlzLnN1aXRlQ250Lmhhcyh0aGlzLmxldmVsKVxuICAgICAgICAgICAgICAgID8gdGhpcy5zdWl0ZUNudC5nZXQodGhpcy5sZXZlbClcbiAgICAgICAgICAgICAgICA6IDBcbiAgICAgICAgICAgIGNvbnN0IHN1aXRlSWQgPSBgc3VpdGUtJHt0aGlzLmxldmVsfS0ke3N1aXRlQ250fWBcblxuICAgICAgICAgICAgaWYgKHRoaXMuc3VpdGVDbnQuaGFzKHRoaXMubGV2ZWwpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdWl0ZUNudC5zZXQodGhpcy5sZXZlbCwgdGhpcy5zdWl0ZUNudC5nZXQodGhpcy5sZXZlbCkgKyAxKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN1aXRlQ250LnNldCh0aGlzLmxldmVsLCAxKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBjb25zdCBzdWl0ZUlkID0gdGhpcy5nZXRTeW5jRXZlbnRJZFN0YXJ0KCdzdWl0ZScpXG4gICAgICAgICAgICB0aGlzLnN1aXRlSWRzLnB1c2goYCR7dGhpcy5sZXZlbH0ke3N1aXRlQ250fWApXG4gICAgICAgICAgICB0aGlzLmxldmVsKytcbiAgICAgICAgICAgIHJldHVybiBzdWl0ZUlkXG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ3N1aXRlOmVuZCcpIHtcbiAgICAgICAgICAgIHRoaXMubGV2ZWwtLVxuICAgICAgICAgICAgY29uc3Qgc3VpdGVDbnQgPSB0aGlzLnN1aXRlQ250LmdldCh0aGlzLmxldmVsKSAtIDFcbiAgICAgICAgICAgIGNvbnN0IHN1aXRlSWQgPSBgc3VpdGUtJHt0aGlzLmxldmVsfS0ke3N1aXRlQ250fWBcbiAgICAgICAgICAgIHRoaXMuc3VpdGVJZHMucG9wKClcbiAgICAgICAgICAgIHJldHVybiBzdWl0ZUlkXG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ2hvb2s6c3RhcnQnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTeW5jRXZlbnRJZFN0YXJ0KCdob29rJylcbiAgICAgICAgfVxuICAgICAgICBpZiAobWVzc2FnZS50eXBlID09PSAnaG9vazplbmQnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTeW5jRXZlbnRJZEVuZCgnaG9vaycpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKFsndGVzdDpzdGFydCcsICd0ZXN0OnBlbmRpbmcnXS5pbmNsdWRlcyhtZXNzYWdlLnR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTeW5jRXZlbnRJZFN0YXJ0KCd0ZXN0JylcbiAgICAgICAgfVxuICAgICAgICBpZiAoWyd0ZXN0OmVuZCcsICd0ZXN0OnBhc3MnLCAndGVzdDpmYWlsJ10uaW5jbHVkZXMobWVzc2FnZS50eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3luY0V2ZW50SWRFbmQoJ3Rlc3QnKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIG1lc3NhZ2UgdHlwZSA6ICR7bWVzc2FnZS50eXBlfWApXG4gICAgfVxufVxuXG5jb25zdCBhZGFwdGVyRmFjdG9yeSA9IHt9XG5cbmFkYXB0ZXJGYWN0b3J5LmluaXQgPSBhc3luYyBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgIGNvbnN0IGFkYXB0ZXIgPSBuZXcgTW9jaGFBZGFwdGVyKC4uLmFyZ3MpXG4gICAgY29uc3QgaW5zdGFuY2UgPSBhd2FpdCBhZGFwdGVyLmluaXQoKVxuICAgIHJldHVybiBpbnN0YW5jZVxufVxuXG5leHBvcnQgZGVmYXVsdCBhZGFwdGVyRmFjdG9yeVxuZXhwb3J0IHsgTW9jaGFBZGFwdGVyLCBhZGFwdGVyRmFjdG9yeSB9XG4iXX0=